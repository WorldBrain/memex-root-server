variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build
  # - test
  - deploy
  - migrate

build:
  stage: build
  image: node:8
  script:
    - npm install
    - npm run prepare
  artifacts:
    paths:
      - build/
      - node_modules/

# test:
#   stage: test
#   image: node:8
#   script:
#     - npm run test:mocha
#   only:
#     - staging
#     - production

deploy:
  stage: deploy
  image: ruby:2.5
  environment:
    name: "${CI_COMMIT_REF_NAME}"
  script:
    - echo "Deploying to ${CI_ENVIRONMENT_NAME}"
    - gem install dpl
    - >
      dpl
      --provider=lambda
      --runtime=nodejs8.10
      --access_key_id="${AWS_ACCESS_KEY}"
      --secret_access_key="${AWS_SECRET_KEY}"
      --region=eu-central-1
      --function_name="${LAMBDA_FUNCTION_PREFIX}-${CI_ENVIRONMENT_NAME}"
      --environment_variables=TIER=${CI_ENVIRONMENT_NAME}
      --environment_variables=COOKIE_SECRET=${COOKIE_SECRET}
      --environment_variables=GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      --environment_variables=GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      --environment_variables=WORLDBRAIN_WP_CLIENT_ID=${WORLDBRAIN_WP_CLIENT_ID}
      --environment_variables=WORLDBRAIN_WP_CLIENT_SECRET=${WORLDBRAIN_WP_CLIENT_SECRET}
      --environment_variables=ADMIN_ACCESS_CODE=${ADMIN_ACCESS_CODE}
      --environment_variables=RDS_USERNAME=${RDS_USERNAME}
      --environment_variables=RDS_PASSWORD=${RDS_PASSWORD}
      --role="${AWS_LAMBDA_ROLE}"
      --module_name="build/main-lambda"
      --handler_name="handler"
  only:
    - staging
    - production

migrate:
  stage: migrate
  image: sequenceiq/alpine-dev
  environment:
    name: "${CI_COMMIT_REF_NAME}"
  script:
    # - echo curl -v "https://staging.memex.cloud/admin/migrate&tier=${CI_ENVIRONMENT_NAME}&access-code=${ADMIN_ACCESS_CODE}"
    - >
      curl -v
      "https://c30qypeazc.execute-api.eu-central-1.amazonaws.com/latest/admin/migrate&tier=${CI_ENVIRONMENT_NAME}&access-code=${ADMIN_ACCESS_CODE}"
      --cookie "mirgrationAccessCode=${ADMIN_ACCESS_CODE}"
  only:
    - staging
    - production
